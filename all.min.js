function DataLayout(a){function b(a,b,e){i(a),l=b.radius;var g=a.map(h);m.stop(),m.nodes(g),m.on("tick",function(h){c(a,h),d(g),f(g,e),b.render()}),m.start()}function c(b,c){var d=.1*c.alpha;b.forEach(function(b){var c=a(b),e=b.point;e.y+=(c.y-e.y)*d,e.x+=(c.x-e.x)*d})}function d(a){var b=d3.geom.quadtree(a);a.forEach(function(a){var c=e(a);b.visit(c)})}function e(a){var b=l,c=a.x-b,d=a.x+b,e=a.y-b,f=a.y+b;return function(b,g,h,i,j){if(b.point&&b.point!==a){var k=a.x-b.point.x,m=a.y-b.point.y,n=Math.sqrt(k*k+m*m),o=2*l;o>n&&(n>0?(n=(n-o)/n*.5,a.x-=k*=n,a.y-=m*=n):a.x+=l,b.point.x+=k,b.point.y+=m)}return g>d||c>i||h>f||e>j}}function f(a,b){a.forEach(function(a){a.x=g(a.x,b.x+l,b.width-l),a.y=g(a.y,b.y+l,b.height-l)})}function g(a,b,c){return Math.max(b,Math.min(c,a))}function h(a){return a.point}function i(a){a.forEach(j)}function j(b){b.point||(b.point=a(b),k(b.point))}function k(a){a.x+=2*Math.random()*l-l}this.startLayout=b;var l,m=d3.layout.force().gravity(0).charge(0)}function DataRenderer(a,b,c){function d(){var c=a.selectAll("image").data(b,getId);c.call(e),c.enter().append("image").attr("class","dot").attr("xlink:href",h).call(e).on("click",function(a){window.open(a.link)}),c.exit().remove()}function e(a){a.attr("width",2*j).attr("height",2*j).attr("x",f).attr("y",g)}function f(a){return a.point.x-j}function g(a){return a.point.y-j}function h(a){return a.image}function i(){var a=c.width*c.height,d=Math.max(1,b.length);return Math.sqrt(a/(10*d))/2}var j=i();this.radius=j,this.render=d}function EbayApi(){function a(a,c,d,e){function f(a){try{var b=c(a)}catch(f){return void e(f)}d(b)}b(a,f,e)}function b(a,b,c){console.log(a),$.ajax({url:a,dataType:"jsonp",success:b,error:c})}var c=new EbayUrlBuilder,d=new EbayResponseParser;this.find=function(b,e,f){var g=c.buildFindUrl(b);a(g,d.parseFind,e,f)},this.histograms=function(b,e,f){var g=c.buildHistogramsUrl(b);a(g,d.parseHistograms,e,f)}}function EbayResponseParser(){function a(a){return{totalItems:+a.paginationOutput[0].totalEntries[0],itemsReturned:+a.searchResult[0]["@count"]}}function b(a){var b=a.findItemsAdvancedResponse[0];if(!b)throw"No response";var c=b.ack[0];if("Success"!=c)throw"Error response: "+b.errorMessage[0].error[0].message[0];return!0}function c(a){var b=a.listingInfo[0],c=b.endTime[0],e=a.primaryCategory[0],f=a.sellingStatus[0].currentPrice[0],g=a.shippingInfo[0].shipToLocations[0];return{id:a.itemId[0],title:a.title[0],category:{id:+e.categoryId[0],name:e.categoryName[0]},aspects:{},condition:d(a),listingType:b.listingType[0],end:EbayApi.stringToDate(c),price:{currency:f["@currencyId"],value:+f.__value__},site:a.globalId[0],country:a.country[0],shipTo:g,image:a.galleryURL[0],link:a.viewItemURL[0]}}function d(a){var b={};if(a.condition&&a.condition[0]){var c=a.condition[0];c&&(b={id:+c.conditionId[0],name:c.conditionDisplayName[0]})}return b}this.parseFind=function(d){if(b(d)){var e=d.findItemsAdvancedResponse[0],f=e.searchResult[0].item||[];if(!f.length)throw"Returned zero items";return{items:f.map(c),metadata:a(e)}}},this.parseHistograms=function(a){var b=a.getHistogramsResponse[0].aspectHistogramContainer[0].aspect;return b.map(function(a){return{name:a["@name"],values:a.valueHistogram.map(function(a){return a["@valueName"]})}})}}function EbayUrlBuilder(){function a(a){var b="",c=a.filters.find(d("Site"));if(c){var e=c.selected[0];b+="&GLOBAL-ID="+e.id}return b}function b(a){var b="",c=a.filters.find(d("Category"));if(c){var e=c.selected;e.forEach(function(a,c){b+="&categoryId("+c+")="+a.id})}return b}function c(a){var b="",c=a.filters.find(d("End"));if(c){var e=a.filters.count(f),g=c.filter.buildUrlParam;b+=g(c,e)}return b}function d(a){return function(b){return b.filter.name==a}}function e(a){var b=a.filters.filter(f);return h(k,b)}function f(a){var b=a.filter.name;return"Site"!=b&&"Category"!=b&&"End"!=b}function g(a){return h(l,a.aspects)}function h(a,b){var c="";return b&&b.forEach(function(b,d){c+=i(b,d,a)}),c}function i(a,b,c){var d=c.nameParam(b,a.filter.name),e=a.filter.getValueId,f=a.selected.map(e);return f.forEach(function(a,e){d+=c.valueParam(b,e,a)}),d}var j="VictorBa-91f0-4b04-b497-3a5e426e0ece";this.buildFindUrl=function(d){return"http://svcs.ebay.com/services/search/FindingService/v1?OPERATION-NAME=findItemsAdvanced&SERVICE-VERSION=1.0.0&SECURITY-APPNAME="+j+"&RESPONSE-DATA-FORMAT=json&keywords="+d.keywords+a(d)+b(d)+e(d)+c(d)+g(d)+"&paginationInput.entriesPerPage="+d.itemsPerPage+"&paginationInput.pageNumber="+d.page};var k={nameParam:function(a,b){return"&itemFilter("+a+").name="+b},valueParam:function(a,b,c){return"&itemFilter("+a+").value("+b+")="+c}},l={nameParam:function(a,b){return"&aspectFilter("+a+").aspectName="+b},valueParam:function(a,b,c){return"&aspectFilter("+a+").aspectValueName("+b+")="+c}};this.buildHistogramsUrl=function(a){return"http://svcs.ebay.com/services/search/FindingService/v1?OPERATION-NAME=getHistograms&SERVICE-VERSION=1.0.0&SECURITY-APPNAME="+j+"&RESPONSE-DATA-FORMAT=json&categoryId="+a.categoryId}}function init(){Main.init(),ChartRenderer.init(),Categories.init(),Config.init(),ChartManager.init(),ItemFinder.init(),RequestLog.init(),RequestLogUI.init(),AspectsFinder.init(),Items.init()}function naturalSort(a,b){"use strict";var c,d,e=/(^([+\-]?(?:0|[1-9]\d*)(?:\.\d*)?(?:[eE][+\-]?\d+)?)?$|^0x[0-9a-f]+$|\d+)/gi,f=/(^[ ]*|[ ]*$)/g,g=/(^([\w ]+,?[\w ]+)?[\w ]+,?[\w ]+\d+:\d+(:\d+)?[\w ]?|^\d{1,4}[\/\-]\d{1,4}[\/\-]\d{1,4}|^\w+, \w+ \d+, \d{4})/,h=/^0x[0-9a-f]+$/i,i=/^0/,j=function(a){return naturalSort.insensitive&&(""+a).toLowerCase()||""+a},k=j(a).replace(f,"")||"",l=j(b).replace(f,"")||"",m=k.replace(e,"\x00$1\x00").replace(/\0$/,"").replace(/^\0/,"").split("\x00"),n=l.replace(e,"\x00$1\x00").replace(/\0$/,"").replace(/^\0/,"").split("\x00"),o=parseInt(k.match(h),16)||1!==m.length&&k.match(g)&&Date.parse(k),p=parseInt(l.match(h),16)||o&&l.match(g)&&Date.parse(l)||null;if(p){if(p>o)return-1;if(o>p)return 1}for(var q=0,r=Math.max(m.length,n.length);r>q;q++){if(c=!(m[q]||"").match(i)&&parseFloat(m[q])||m[q]||0,d=!(n[q]||"").match(i)&&parseFloat(n[q])||n[q]||0,isNaN(c)!==isNaN(d))return isNaN(c)?1:-1;if(typeof c!=typeof d&&(c+="",d+=""),d>c)return-1;if(c>d)return 1}return 0}function identity(a){return a}function getId(a){return a.id}function getName(a){return a.name}function notEmpty(a){return a&&a.length>0}function mapAsObject(a,b){for(var c,d={},e=0;c=a[e];e++){var f=b(c);d[f]=c}return d}function Set(a){this._hashFunction=a||JSON.stringify,this._values={},this._size=0}var ChartCommon=function(){var a={};return a.findOrdinalDomain=function(a,b){var c=new Set;return c.addMap(a,b),c.toArray().sort(naturalSort)},a.replaceUndefined=function(a){return a?a:"?"},a}(this),COUNTRY_CODES=[{id:"AF",name:"Afghanistan"},{id:"AX",name:"Åland Islands"},{id:"AL",name:"Albania"},{id:"DZ",name:"Algeria"},{id:"AS",name:"American Samoa"},{id:"AD",name:"Andorra"},{id:"AO",name:"Angola"},{id:"AI",name:"Anguilla"},{id:"AQ",name:"Antarctica"},{id:"AG",name:"Antigua and Barbuda"},{id:"AR",name:"Argentina"},{id:"AM",name:"Armenia"},{id:"AW",name:"Aruba"},{id:"AU",name:"Australia"},{id:"AT",name:"Austria"},{id:"AZ",name:"Azerbaijan"},{id:"BS",name:"Bahamas"},{id:"BH",name:"Bahrain"},{id:"BD",name:"Bangladesh"},{id:"BB",name:"Barbados"},{id:"BY",name:"Belarus"},{id:"BE",name:"Belgium"},{id:"BZ",name:"Belize"},{id:"BJ",name:"Benin"},{id:"BM",name:"Bermuda"},{id:"BT",name:"Bhutan"},{id:"BO",name:"Bolivia, Plurinational State of"},{id:"BQ",name:"Bonaire, Sint Eustatius and Saba"},{id:"BA",name:"Bosnia and Herzegovina"},{id:"BW",name:"Botswana"},{id:"BV",name:"Bouvet Island"},{id:"BR",name:"Brazil"},{id:"IO",name:"British Indian Ocean Territory"},{id:"BN",name:"Brunei Darussalam"},{id:"BG",name:"Bulgaria"},{id:"BF",name:"Burkina Faso"},{id:"BI",name:"Burundi"},{id:"KH",name:"Cambodia"},{id:"CM",name:"Cameroon"},{id:"CA",name:"Canada"},{id:"CV",name:"Cape Verde"},{id:"KY",name:"Cayman Islands"},{id:"CF",name:"Central African Republic"},{id:"TD",name:"Chad"},{id:"CL",name:"Chile"},{id:"CN",name:"China"},{id:"CX",name:"Christmas Island"},{id:"CC",name:"Cocos (Keeling) Islands"},{id:"CO",name:"Colombia"},{id:"KM",name:"Comoros"},{id:"CG",name:"Congo"},{id:"CD",name:"Congo, the Democratic Republic of the"},{id:"CK",name:"Cook Islands"},{id:"CR",name:"Costa Rica"},{id:"CI",name:"Côte d'Ivoire"},{id:"HR",name:"Croatia"},{id:"CU",name:"Cuba"},{id:"CW",name:"Curaçao"},{id:"CY",name:"Cyprus"},{id:"CZ",name:"Czech Republic"},{id:"DK",name:"Denmark"},{id:"DJ",name:"Djibouti"},{id:"DM",name:"Dominica"},{id:"DO",name:"Dominican Republic"},{id:"EC",name:"Ecuador"},{id:"EG",name:"Egypt"},{id:"SV",name:"El Salvador"},{id:"GQ",name:"Equatorial Guinea"},{id:"ER",name:"Eritrea"},{id:"EE",name:"Estonia"},{id:"ET",name:"Ethiopia"},{id:"FK",name:"Falkland Islands (Malvinas)"},{id:"FO",name:"Faroe Islands"},{id:"FJ",name:"Fiji"},{id:"FI",name:"Finland"},{id:"FR",name:"France"},{id:"GF",name:"French Guiana"},{id:"PF",name:"French Polynesia"},{id:"TF",name:"French Southern Territories"},{id:"GA",name:"Gabon"},{id:"GM",name:"Gambia"},{id:"GE",name:"Georgia"},{id:"DE",name:"Germany"},{id:"GH",name:"Ghana"},{id:"GI",name:"Gibraltar"},{id:"GR",name:"Greece"},{id:"GL",name:"Greenland"},{id:"GD",name:"Grenada"},{id:"GP",name:"Guadeloupe"},{id:"GU",name:"Guam"},{id:"GT",name:"Guatemala"},{id:"GG",name:"Guernsey"},{id:"GN",name:"Guinea"},{id:"GW",name:"Guinea-Bissau"},{id:"GY",name:"Guyana"},{id:"HT",name:"Haiti"},{id:"HM",name:"Heard Island and McDonald Islands"},{id:"VA",name:"Holy See (Vatican City State)"},{id:"HN",name:"Honduras"},{id:"HK",name:"Hong Kong"},{id:"HU",name:"Hungary"},{id:"IS",name:"Iceland"},{id:"IN",name:"India"},{id:"ID",name:"Indonesia"},{id:"IR",name:"Iran, Islamic Republic of"},{id:"IQ",name:"Iraq"},{id:"IE",name:"Ireland"},{id:"IM",name:"Isle of Man"},{id:"IL",name:"Israel"},{id:"IT",name:"Italy"},{id:"JM",name:"Jamaica"},{id:"JP",name:"Japan"},{id:"JE",name:"Jersey"},{id:"JO",name:"Jordan"},{id:"KZ",name:"Kazakhstan"},{id:"KE",name:"Kenya"},{id:"KI",name:"Kiribati"},{id:"KP",name:"Korea, Democratic People's Republic of"},{id:"KR",name:"Korea, Republic of"},{id:"KW",name:"Kuwait"},{id:"KG",name:"Kyrgyzstan"},{id:"LA",name:"Lao People's Democratic Republic"},{id:"LV",name:"Latvia"},{id:"LB",name:"Lebanon"},{id:"LS",name:"Lesotho"},{id:"LR",name:"Liberia"},{id:"LY",name:"Libya"},{id:"LI",name:"Liechtenstein"},{id:"LT",name:"Lithuania"},{id:"LU",name:"Luxembourg"},{id:"MO",name:"Macao"},{id:"MK",name:"Macedonia, the Former Yugoslav Republic of"},{id:"MG",name:"Madagascar"},{id:"MW",name:"Malawi"},{id:"MY",name:"Malaysia"},{id:"MV",name:"Maldives"},{id:"ML",name:"Mali"},{id:"MT",name:"Malta"},{id:"MH",name:"Marshall Islands"},{id:"MQ",name:"Martinique"},{id:"MR",name:"Mauritania"},{id:"MU",name:"Mauritius"},{id:"YT",name:"Mayotte"},{id:"MX",name:"Mexico"},{id:"FM",name:"Micronesia, Federated States of"},{id:"MD",name:"Moldova, Republic of"},{id:"MC",name:"Monaco"},{id:"MN",name:"Mongolia"},{id:"ME",name:"Montenegro"},{id:"MS",name:"Montserrat"},{id:"MA",name:"Morocco"},{id:"MZ",name:"Mozambique"},{id:"MM",name:"Myanmar"},{id:"NA",name:"Namibia"},{id:"NR",name:"Nauru"},{id:"NP",name:"Nepal"},{id:"NL",name:"Netherlands"},{id:"NC",name:"New Caledonia"},{id:"NZ",name:"New Zealand"},{id:"NI",name:"Nicaragua"},{id:"NE",name:"Niger"},{id:"NG",name:"Nigeria"},{id:"NU",name:"Niue"},{id:"NF",name:"Norfolk Island"},{id:"MP",name:"Northern Mariana Islands"},{id:"NO",name:"Norway"},{id:"OM",name:"Oman"},{id:"PK",name:"Pakistan"},{id:"PW",name:"Palau"},{id:"PS",name:"Palestine, State of"},{id:"PA",name:"Panama"},{id:"PG",name:"Papua New Guinea"},{id:"PY",name:"Paraguay"},{id:"PE",name:"Peru"},{id:"PH",name:"Philippines"},{id:"PN",name:"Pitcairn"},{id:"PL",name:"Poland"},{id:"PT",name:"Portugal"},{id:"PR",name:"Puerto Rico"},{id:"QA",name:"Qatar"},{id:"RE",name:"Réunion"},{id:"RO",name:"Romania"},{id:"RU",name:"Russian Federation"},{id:"RW",name:"Rwanda"},{id:"BL",name:"Saint Barthélemy"},{id:"SH",name:"Saint Helena, Ascension and Tristan da Cunha"},{id:"KN",name:"Saint Kitts and Nevis"},{id:"LC",name:"Saint Lucia"},{id:"MF",name:"Saint Martin (French part)"},{id:"PM",name:"Saint Pierre and Miquelon"},{id:"VC",name:"Saint Vincent and the Grenadines"},{id:"WS",name:"Samoa"},{id:"SM",name:"San Marino"},{id:"ST",name:"Sao Tome and Principe"},{id:"SA",name:"Saudi Arabia"},{id:"SN",name:"Senegal"},{id:"RS",name:"Serbia"},{id:"SC",name:"Seychelles"},{id:"SL",name:"Sierra Leone"},{id:"SG",name:"Singapore"},{id:"SX",name:"Sint Maarten (Dutch part)"},{id:"SK",name:"Slovakia"},{id:"SI",name:"Slovenia"},{id:"SB",name:"Solomon Islands"},{id:"SO",name:"Somalia"},{id:"ZA",name:"South Africa"},{id:"GS",name:"South Georgia and the South Sandwich Islands"},{id:"SS",name:"South Sudan"},{id:"ES",name:"Spain"},{id:"LK",name:"Sri Lanka"},{id:"SD",name:"Sudan"},{id:"SR",name:"Suriname"},{id:"SJ",name:"Svalbard and Jan Mayen"},{id:"SZ",name:"Swaziland"},{id:"SE",name:"Sweden"},{id:"CH",name:"Switzerland"},{id:"SY",name:"Syrian Arab Republic"},{id:"TW",name:"Taiwan, Province of China"},{id:"TJ",name:"Tajikistan"},{id:"TZ",name:"Tanzania, United Republic of"},{id:"TH",name:"Thailand"},{id:"TL",name:"Timor-Leste"},{id:"TG",name:"Togo"},{id:"TK",name:"Tokelau"},{id:"TO",name:"Tonga"},{id:"TT",name:"Trinidad and Tobago"},{id:"TN",name:"Tunisia"},{id:"TR",name:"Turkey"},{id:"TM",name:"Turkmenistan"},{id:"TC",name:"Turks and Caicos Islands"},{id:"TV",name:"Tuvalu"},{id:"UG",name:"Uganda"},{id:"UA",name:"Ukraine"},{id:"AE",name:"United Arab Emirates"},{id:"GB",name:"United Kingdom"},{id:"US",name:"United States"},{id:"UM",name:"United States Minor Outlying Islands"},{id:"UY",name:"Uruguay"},{id:"UZ",name:"Uzbekistan"},{id:"VU",name:"Vanuatu"},{id:"VE",name:"Venezuela, Bolivarian Republic of"},{id:"VN",name:"Viet Nam"},{id:"VG",name:"Virgin Islands, British"},{id:"VI",name:"Virgin Islands, U.S."},{id:"WF",name:"Wallis and Futuna"},{id:"EH",name:"Western Sahara"},{id:"YE",name:"Yemen"},{id:"ZM",name:"Zambia"},{id:"ZW",name:"Zimbabwe"}],SITE_IDS=[{id:"EBAY-US",name:"United States"},{id:"EBAY-ENCA",name:"Canada (English)"},{id:"EBAY-FRCA",name:"Canada (French)"},{id:"EBAY-GB",name:"UK"},{id:"EBAY-AU",name:"Australia"},{id:"EBAY-AT",name:"Austria"},{id:"EBAY-FRBE",name:"Belgium (French)"},{id:"EBAY-NLBE",name:"Belgium (Dutch)"},{id:"EBAY-FR",name:"France"},{id:"EBAY-DE",name:"Germany"},{id:"EBAY-MOTOR",name:"Motors"},{id:"EBAY-IT",name:"Italy"},{id:"EBAY-NL",name:"Netherlands"},{id:"EBAY-ES",name:"Spain"},{id:"EBAY-CH",name:"Switzerland"},{id:"EBAY-HK",name:"Hong Kong"},{id:"EBAY-IN",name:"India"},{id:"EBAY-IE",name:"Ireland"},{id:"EBAY-MY",name:"Malaysia"},{id:"EBAY-PH",name:"Philippines"},{id:"EBAY-PL",name:"Poland"},{id:"EBAY-SG",name:"Singapore"}];Array.prototype.chunk=function(a){var b=this;return[].concat.apply([],b.map(function(c,d){return d%a?[]:[b.slice(d,d+a)]}))},Array.prototype.pushAll=function(a){this.push.apply(this,a)},Array.prototype.find=function(a,b){var c=null,d=this;return this.some(function(e,f){return a(e,f,d,b)?(c=e,!0):!1}),c},Array.prototype.contains=function(a){return this.indexOf(a)>-1},Array.prototype.count=function(a){return this.filter(a).length},toUTC=function(a){var b=a.getTime()+6e4*a.getTimezoneOffset();return new Date(b)},toLocal=function(a){var b=6e4*(new Date).getTimezoneOffset(),c=a.getTime()-b;return new Date(c)},getDate=function(a){return a.setHours(0,0,0,0)},addMinutes=function(a,b){return new Date(a.getTime()+60*b*1e3)},addHours=function(a,b){return new Date(a.getTime()+60*b*60*1e3)},addDays=function(a,b){return new Date(a.getTime()+24*b*60*60*1e3)};var AspectGuesser=function(){function a(a,c){var d=b(a,c);f(d,a)}function b(a,b){for(var d,e={},f=c(a),g=0;d=f[g];g++){var h=b.fuzzyValues.get(d);if(h){var i={confidence:h[0][0],value:h[0][1]},j=b.aspectValuesMap[h[0][1]].name;(!e[j]||e[j].confidence<i.confidence)&&(e[j]=i)}}return e}function c(a){var b=a.title.split(" "),c=[];return c.pushAll(b),c.pushAll(d(2,b)),c.pushAll(d(3,b)),c}function d(a,b){for(var c=[],d=0,f=b.length-(a-1);f>d;d++){var g=e(a,b,d);c.push(g)}return c}function e(a,b,c){for(var d=[],e=0;a>e;e++)d.push(b[c+e]);return d.join(" ")}function f(a,b){for(var c in a)if(a.hasOwnProperty(c)){var d=a[c],e=b.aspects[c];(!e||e.confidence<d.confidence)&&(b.aspects[c]=d)}}var g={};return g.guessAspectsFromTitle=function(b){b.forEach(function(b){var c=Categories.get(b.category);c&&c.fuzzyValues&&a(b,c)})},g}(),AxisFactory=function(){function a(a,b){this.label=a,this.getProperty=b,this.getScale=d3.scale.linear,this.updateDomain=e(this)}function b(a,b){this.label=a,this.getProperty=b,this.getScale=d3.time.scale,this.updateDomain=e(this)}function c(a,b){this.label=a,this.getProperty=b,this.getScale=d3.scale.ordinal,this.updateDomain=f(this),this.formatTick=ChartCommon.replaceUndefined}function d(a){return new c(a,function(b){var c=b.aspects[a]||{};return c.value})}function e(a){return function(b,c){var d=d3.extent(c,a.getProperty);b.domain(d)}}function f(a){return function(b,c){var d=ChartCommon.findOrdinalDomain(c,a.getProperty);b.domain(d)}}var g={};g.priceAxis=new a("Price",function(a){return a.price.value});var h=new c("Category",function(a){return a.category.name}),i=new c("Condition",function(a){return a.condition.name}),j=new c("ListingType",function(a){return a.listingType}),k=new b("End",function(a){return a.end});return g.listOptions=function(){var a=[h,i,j,k];return Categories.each(function(b){b.aspects.forEach(function(b){a.push(d(b.name))})}),a},g}(),ChartManager=function(){function a(){d&&ChartRenderer.update(d,AxisFactory.priceAxis,f)}function b(a){Filters.populate(),Categories.populate(a)}function c(a){return function(b){return b.label==a}}var d,e,f,g={};return g.init=function(){d=[],g.updateAxisOptions(),f=e[0],a()},g.onNewItems=function(a){b(a),g.updateAxisOptions(),g.setData(a)},g.setData=function(a){d=a,ChartRenderer.setData(d)},g.updateAxisOptions=function(){e=AxisFactory.listOptions()},g.changeAxisByName=function(b){var d=e.find(c(b));d&&(f=d,a())},g.getXAxis=function(){return f},g}(),ChartRenderer=function(){function a(){var a=d3.select(G).node();b(a.clientWidth,a.clientHeight)}function b(a,b){r=a,s=b,t=r-H.left-H.right,u=s-H.top-H.bottom,c()}function c(){d3.select(G).html(""),v=d3.select(G).append("svg").attr("width",r).attr("height",s),w=v.append("g").attr("transform","translate("+H.left+","+H.top+")")}function d(){a(),e()}function e(){f(),B=new n,B.init(),g()}function f(){z=o(y.getScale()),A=p(x.getScale())}function g(){j(),B.update(),C=new DataRenderer(w,E,h()),D.startLayout(E,C,h()),i()}function h(){return{x:0,y:0,width:t,height:u}}function i(){$(G).find("svg").tooltip(ItemTooltip.getParams())}function j(){y.updateDomain(z,E),x.updateDomain(A,E)}function k(a){return{x:l(a),y:m(a)}}function l(a){return z(y.getProperty(a))}function m(a){return A(x.getProperty(a))}function n(){var a=d3.svg.axis().scale(z).orient("bottom");y.formatTick&&a.tickFormat(y.formatTick);var b=d3.svg.axis().scale(A).orient("left");this.init=function(){w.selectAll(".axis").remove(),w.append("g").attr("class","x axis").attr("transform","translate(0,"+u+")").call(a).append("text").attr("class","x label").attr("x",t).attr("y",-6).text(y.label),w.append("g").attr("class","y axis").call(b).append("text").attr("class","y label").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").text(x.label)},this.update=function(){w.selectAll(".axis").filter(".x").call(a),w.selectAll(".axis").filter(".y").call(b)}}function o(a){return q(a)?a.rangePoints([0,t],.5):a.range([0,t]),a}function p(a){return a.range([u,0]),a}function q(a){return"function"==typeof a.rangePoints}var r,s,t,u,v,w,x,y,z,A,B,C,D,E,F={},G="#chart",H={top:0,right:2,bottom:40,left:40};return F.init=function(){D=new DataLayout(k),a(),d3.select(window).on("resize",d)},F.setData=function(a){E=a,g()},F.update=function(a,b,c){x=b,y=c,E=a,e()},F}(),ItemTooltip=function(){function a(){var a=this.__data__,b=a.price.currency+" "+a.price.value;return"<div class='chart-tooltip'><p>"+a.title+"</p><img src='"+a.image+"'/><p>"+b+"</p></div>"}var b={};return b.getParams=function(){return{items:"image",track:!0,content:a}},b}(),Config=function(){function a(){var a=c(),e=b(a),f=b("US");d=COUNTRY_CODES.find(e)||COUNTRY_CODES.find(f)}function b(a){return function(b){return b.id==a}}function c(){var a=navigator.language,b=/(\w\w)-(\w\w)/i,c=new RegExp(b),d=c.exec(a);return d[2]||"US"}var d,e={};SITE_IDS[0];e.init=function(){a()};return e}();EbayApi.dateFormat=d3.time.format("%Y-%m-%dT%H:%M:%S.%LZ"),EbayApi.dateToString=function(a){return EbayApi.dateFormat(toUTC(a))},EbayApi.stringToDate=function(a){return toLocal(EbayApi.dateFormat.parse(a))};var AspectsFinder=function(){function a(a){return function(d){b(d),c(a,d),ChartManager.updateAxisOptions(),e(a),FilterUI.populate(d).classed("aspect-filter",!0)}}function b(a){a.forEach(function(a){a.getValueLabel=identity,a.getValueId=identity})}function c(a,b){a.aspects=b,a.aspectValuesMap=d(b);var c=Object.keys(a.aspectValuesMap);a.fuzzyValues=FuzzySet(c)}function d(a){for(var b,c={},d=0;b=a[d];d++)for(var e,f=0;e=b.values[f];f++)c[e]=b;return c}function e(a){var b=Items.getByCategory(a);AspectGuesser.guessAspectsFromTitle(b)}var f,g={};return g.init=function(){f=new EbayApi},g.find=function(b){var c=Categories.get(b);if(0==c.aspects.length){var d=a(c);f.histograms({categoryId:b.id},d)}},g}(),Categories=function(){function a(a){var b=d3.map(a,function(a){return a.category.id}),c=b.keys();return c.map(function(a){var c=b.get(a);return{id:c.category.id,name:c.category.name,aspects:[]}})}function b(a){var b={name:"Category",values:a,getValueLabel:getName,getValueId:getId};FilterUI.populate([b]).classed("common-filter",!0).selectAll("option").on("click",AspectsFinder.find),AspectsFinder.find(a[0])}var c,d={};return d.init=function(){c=new Set(getId)},d.populate=function(d){var e=a(d);c.addAll(e),b(e)},d.each=function(a){c.each(a)},d.get=function(a){return c.get(a)},d}(),FilterUI=function(){function a(a){var b=e(a).enter().append("div").classed("filter",!0),c=b.append("div").classed("top",!0);c.append("div").classed("arrow",!0).classed("right",!0),c.append("div").classed("title",!0).html(getName)}function b(a){a.append("select").attr("id",f).each(d)}function c(a){e(a).select("select").each(d)}function d(a){var b=a.getValueLabel;d3.select(this).attr("size",a.values.length).attr("multiple",!0),d3.select(this).selectAll("option").data(a.values,b).enter().append("option").html(b)}function e(a){return d3.select("#filters").selectAll("div.filter").data(a,getName)}function f(a){return"filter-"+a.name}function g(a){var b=ChartManager.getXAxis();return b&&a.name==b.label}function h(a){var c=d3.select(a);b(c),ListenerAssigner.bindFilterListeners(),j(a)}function i(a,b){b.remove(),k(a)}function j(a){d3.select(a).select(".arrow").classed("bottom",!0).classed("right",!1)}function k(a){d3.select(a).select(".arrow").classed("bottom",!1).classed("right",!0)}var l={};return l.populate=function(b){return a(b),c(b),ListenerAssigner.bindFilterListeners(),e(b)},l.refresh=function(){d3.select("#filters").selectAll("div.filter").selectAll(".arrow").classed("active",g)},l.toggleExpanded=function(a){var b=$(a).find("select");b.length?i(a,b):h(a)},l}(),Filters=function(){function a(a,b){if(b&&b.selected.length){var c=b.selected[0],d=new Date,e=c.getTime(d);return a.end<=e}}function b(a,b){var d=b,e="";if(a&&a.selected.length){var f=a.selected[0],g=new Date,h=f.getTime(g),i=EbayApi.dateToString(h);e+=c(d,"EndTimeTo",i)}return e}function c(a,b,c){return"&itemFilter("+a+").name="+b+"&itemFilter("+a+").value(0)="+c}function d(a,b){return function(c){return a(c,b)}}var e={};e.populate=function(){FilterUI.populate(f).classed("common-filter",!0)};var f=[{name:"Condition",values:[{id:1e3,name:"New"},{id:1500,name:"New other (see details)"},{id:1750,name:"New with defects"},{id:2e3,name:"Manufacturer refurbished"},{id:2500,name:"Seller refurbished"},{id:3e3,name:"Used"},{id:4e3,name:"Very Good"},{id:5e3,name:"Good"},{id:6e3,name:"Acceptable"},{id:7e3,name:"For parts or not working"}],getValueLabel:getName,getValueId:getId},{name:"ListingType",values:["Auction","AuctionWithBIN","Classified","FixedPrice","StoreInventory"],getValueLabel:identity,getValueId:identity},{name:"End",values:[{name:"In 10 minutes",getTime:d(addMinutes,15)},{name:"In 1 hour",getTime:d(addHours,1)},{name:"In 1 day",getTime:d(addDays,1)},{name:"In 7 days",getTime:d(addDays,7)},{name:"In 30 days",getTime:d(addDays,30)}],getValueLabel:getName,getValueId:getName,satisfies:a,buildUrlParam:b}];return e}();$(init);var ItemFilter=function(){function a(a,c){return b(a,c.filters)&&b(a,c.aspects)}function b(a,b){for(var d,e=0;d=b[e];e++)if(!c(a,d))return!1;return!0}function c(a,b){if(b.selected.length){var c=b.filter;return c.satisfies?c.satisfies(a,b):d(a,b)}return!0}function d(a,b){var c=b.filter.name,d=f(c),g=d(a),h=e(b);return h.contains(g)}function e(a){var b=a.filter.getValueId;return a.selected.map(b)}function f(a){return i[a]||g(a)}function g(a){return function(b){var c=b.aspects[a]||{};return c.value}}var h={};h.createFilter=function(b){return function(c){return a(c,b)}};var i={Condition:function(a){return a.condition.id},ListingType:function(a){return a.listingType},Category:function(a){return a.category.id}};return h}(),ItemFinder=function(){function a(a){if(a.lastItem&&a.totalItems&&a.lastItem>=a.totalItems)throw"No new items left for this set of filters"}var b,c={};return c.init=function(){b=new EbayApi},c.find=function(){function c(a){Main.updateChart(f,a.items),RequestLog.notifyRequestSuccessful(f,a.metadata)}function d(a){RequestLog.notifyRequestFailed(f),console.log("Find failed: "+a)}var e=UIParamsInput.getParams();if(e.keywords)try{var f=RequestLog.notifyNewRequestAndGetPaging(e);a(f),b.find(f,c,d)}catch(g){d(g)}},c}(),Items=function(){function a(a,b){for(var c in b.aspects)b.aspects.hasOwnProperty(c)&&(a.aspects[c]=b.aspects[c])}function b(a){return function(b){return b.category.id==a.id}}var c,d={};return d.init=function(){c=new Set(getId)},d.add=function(b){c.addMergeAll(b,a),MessageUI.setTotal(c.size())},d.filter=function(){var a=UIParamsInput.getParams(),b=ItemFilter.createFilter(a);return c.filter(b)},d.getByCategory=function(a){return c.filter(b(a))},d.count=function(){return c.size()},d}();!function(){var a=function(a,b,c,d){var e={version:"0.0.1"};a=a||[],e.gramSizeLower=c||2,e.gramSizeUpper=d||3,e.useLevenshtein="boolean"!=typeof b?!0:b,e.exactSet={},e.matchDict={},e.items={};var f=function(a,b){for(var c,d,e=[],f=0;f<=b.length;f++)for(var g=0;g<=a.length;g++)d=f&&g?a.charAt(g-1)===b.charAt(f-1)?c:Math.min(e[g],e[g-1],c)+1:f+g,c=e[g],e[g]=d;return e.pop()},g=function(a,b){if(null===a&&null===b)throw"Trying to compare two null values";if(null===a||null===b)return 0;a=String(a),b=String(b);var c=f(a,b);return a.length>b.length?1-c/a.length:1-c/b.length},h=/[^\w, ]+/,i=function(a,b){b=b||2;var c="-"+a.toLowerCase().replace(h,"")+"-",d=b-c.length,e=[];if(d>0)for(var f=0;d>f;++f)a+="-";for(var f=0;f<c.length-b+1;++f)e.push(c.slice(f,f+b));return e},j=function(a,b){b=b||2;var c={},d=i(a,b),e=0;for(e;e<d.length;++e)d[e]in c?c[d[e]]+=1:c[d[e]]=1;return c};e.get=function(a,b){var c=this._get(a);return!c&&b?b:c},e._get=function(a){var b=this._normalizeStr(a),c=this.exactSet[b];if(c)return[[1,c]];for(var d=[],e=this.gramSizeUpper;e>=this.gramSizeLower;--e)if(d=this.__get(a,e))return d;return null},e.__get=function(a,b){function c(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0}var d,e,f,h,i,k=this._normalizeStr(a),l={},m=j(k,b),n=this.items[b],o=0;for(d in m)if(e=m[d],o+=Math.pow(e,2),d in this.matchDict)for(f=0;f<this.matchDict[d].length;++f)h=this.matchDict[d][f][0],i=this.matchDict[d][f][1],h in l?l[h]+=e*i:l[h]=e*i;if(c(l))return null;var p,q=Math.sqrt(o),r=[];for(var s in l)p=l[s],r.push([p/(q*n[s][0]),n[s][1]]);var t=function(a,b){return a[0]<b[0]?1:a[0]>b[0]?-1:0};if(r.sort(t),this.useLevenshtein){for(var u=[],v=Math.min(50,r.length),f=0;v>f;++f)u.push([g(r[f][1],k),r[f][1]]);r=u,r.sort(t)}for(var u=[],f=0;f<r.length;++f)r[f][0]==r[0][0]&&u.push([r[f][0],this.exactSet[r[f][1]]]);return u},e.add=function(a){var b=this._normalizeStr(a);if(b in this.exactSet)return!1;var c=this.gramSizeLower;for(c;c<this.gramSizeUpper+1;++c)this._add(a,c)},e._add=function(a,b){var c=this._normalizeStr(a),d=this.items[b]||[],e=d.length;d.push(0);var f,g,h=j(c,b),i=0;for(f in h)g=h[f],i+=Math.pow(g,2),f in this.matchDict?this.matchDict[f].push([e,g]):this.matchDict[f]=[[e,g]];var k=Math.sqrt(i);d[e]=[k,c],this.items[b]=d,this.exactSet[c]=a},e._normalizeStr=function(a){if("[object String]"!==Object.prototype.toString.call(a))throw"Must use a string as argument to FuzzySet functions";return a.toLowerCase()},e.length=function(){var a,b=0;for(a in this.exactSet)this.exactSet.hasOwnProperty(a)&&(b+=1);return b},e.isEmpty=function(){for(var a in this.exactSet)if(this.exactSet.hasOwnProperty(a))return!1;return!0},e.values=function(){var a,b=[];for(a in this.exactSet)this.exactSet.hasOwnProperty(a)&&b.push(this.exactSet[a]);return b};var k=e.gramSizeLower;for(k;k<e.gramSizeUpper+1;++k)e.items[k]=[];for(k=0;k<a.length;++k)e.add(a[k]);return e},b=this;"undefined"!=typeof module&&module.exports?(module.exports=a,b.FuzzySet=a):b.FuzzySet=a}(),function(a,b){function c(a){for(var b,c=a.split(/\s+/),d=[],e=0;b=c[e];e++)b=b.charAt(0).toUpperCase(),d.push(b);return d}function d(b){return b.id&&a('label[for="'+b.id+'"]').val()||b.name}function e(c,f,g){return g||(g=0),f.each(function(){var f,h,i=a(this),j=this,k=this.nodeName.toLowerCase();switch("label"==k&&i.find("input, textarea, select").length&&(f=i.text(),i=i.children().first(),j=i.get(0),k=j.nodeName.toLowerCase()),k){case"menu":h={name:i.attr("label"),items:{}},g=e(h.items,i.children(),g);break;case"a":case"button":h={name:i.text(),disabled:!!i.attr("disabled"),callback:function(){return function(){i.click()}}()};break;case"menuitem":case"command":switch(i.attr("type")){case b:case"command":case"menuitem":h={name:i.attr("label"),disabled:!!i.attr("disabled"),callback:function(){return function(){i.click()}}()};break;case"checkbox":h={type:"checkbox",disabled:!!i.attr("disabled"),name:i.attr("label"),selected:!!i.attr("checked")};break;case"radio":h={type:"radio",disabled:!!i.attr("disabled"),name:i.attr("label"),radio:i.attr("radiogroup"),value:i.attr("id"),selected:!!i.attr("checked")};break;default:h=b}break;case"hr":h="-------";break;case"input":switch(i.attr("type")){case"text":h={type:"text",name:f||d(j),disabled:!!i.attr("disabled"),value:i.val()};break;case"checkbox":h={type:"checkbox",name:f||d(j),disabled:!!i.attr("disabled"),selected:!!i.attr("checked")};break;case"radio":h={type:"radio",name:f||d(j),disabled:!!i.attr("disabled"),radio:!!i.attr("name"),value:i.val(),selected:!!i.attr("checked")};break;default:h=b}break;case"select":h={type:"select",name:f||d(j),disabled:!!i.attr("disabled"),selected:i.val(),options:{}},i.children().each(function(){h.options[this.value]=a(this).text()});break;case"textarea":h={type:"textarea",name:f||d(j),disabled:!!i.attr("disabled"),value:i.val()};break;case"label":break;default:h={type:"html",html:i.clone(!0)}}h&&(g++,c["key"+g]=h)}),g}if(a.support.htmlMenuitem="HTMLMenuItemElement"in window,a.support.htmlCommand="HTMLCommandElement"in window,a.support.eventSelectstart="onselectstart"in document.documentElement,!a.ui||!a.ui.widget){var f=a.cleanData;a.cleanData=function(b){for(var c,d=0;null!=(c=b[d]);d++)try{a(c).triggerHandler("remove")}catch(e){}f(b)}}var g=null,h=!1,i=a(window),j=0,k={},l={},m={},n={selector:null,appendTo:null,trigger:"right",autoHide:!1,delay:200,reposition:!0,determinePosition:function(b){if(a.ui&&a.ui.position)b.css("display","block").position({my:"center top",at:"center bottom",of:this,offset:"0 5",collision:"fit"}).css("display","none");else{var c=this.offset();c.top+=this.outerHeight(),c.left+=this.outerWidth()/2-b.outerWidth()/2,b.css(c)}},
position:function(a,b,c){var d;if(!b&&!c)return void a.determinePosition.call(this,a.$menu);d="maintain"===b&&"maintain"===c?a.$menu.position():{top:c,left:b};var e=i.scrollTop()+i.height(),f=i.scrollLeft()+i.width(),g=a.$menu.height(),h=a.$menu.width();d.top+g>e&&(d.top-=g),d.top<0&&(d.top=0),d.left+h>f&&(d.left-=h),a.$menu.css(d)},positionSubmenu:function(b){if(a.ui&&a.ui.position)b.css("display","block").position({my:"left top",at:"right top",of:this,collision:"flipfit fit"}).css("display","");else{var c={top:0,left:this.outerWidth()};b.css(c)}},zIndex:1,animation:{duration:50,show:"slideDown",hide:"slideUp"},events:{show:a.noop,hide:a.noop},callback:null,items:{}},o={timer:null,pageX:null,pageY:null},p=function(a){for(var b=0,c=a;;)if(b=Math.max(b,parseInt(c.css("z-index"),10)||0),c=c.parent(),!c||!c.length||"html body".indexOf(c.prop("nodeName").toLowerCase())>-1)break;return b},q={abortevent:function(a){a.preventDefault(),a.stopImmediatePropagation()},contextmenu:function(b){var c=a(this);if("right"==b.data.trigger&&(b.preventDefault(),b.stopImmediatePropagation()),!("right"!=b.data.trigger&&b.originalEvent||c.hasClass("context-menu-active")||c.hasClass("context-menu-disabled"))){if(g=c,b.data.build){var d=b.data.build(g,b);if(d===!1)return;if(b.data=a.extend(!0,{},n,b.data,d||{}),!b.data.items||a.isEmptyObject(b.data.items))throw window.console&&(console.error||console.log).call(console,"No items specified to show in contextMenu"),new Error("No Items specified");b.data.$trigger=g,r.create(b.data)}r.show.call(c,b.data,b.pageX,b.pageY)}},click:function(b){b.preventDefault(),b.stopImmediatePropagation(),a(this).trigger(a.Event("contextmenu",{data:b.data,pageX:b.pageX,pageY:b.pageY}))},mousedown:function(b){var c=a(this);g&&g.length&&!g.is(c)&&g.data("contextMenu").$menu.trigger("contextmenu:hide"),2==b.button&&(g=c.data("contextMenuActive",!0))},mouseup:function(b){var c=a(this);c.data("contextMenuActive")&&g&&g.length&&g.is(c)&&!c.hasClass("context-menu-disabled")&&(b.preventDefault(),b.stopImmediatePropagation(),g=c,c.trigger(a.Event("contextmenu",{data:b.data,pageX:b.pageX,pageY:b.pageY}))),c.removeData("contextMenuActive")},mouseenter:function(b){var c=a(this),d=a(b.relatedTarget),e=a(document);d.is(".context-menu-list")||d.closest(".context-menu-list").length||g&&g.length||(o.pageX=b.pageX,o.pageY=b.pageY,o.data=b.data,e.on("mousemove.contextMenuShow",q.mousemove),o.timer=setTimeout(function(){o.timer=null,e.off("mousemove.contextMenuShow"),g=c,c.trigger(a.Event("contextmenu",{data:o.data,pageX:o.pageX,pageY:o.pageY}))},b.data.delay))},mousemove:function(a){o.pageX=a.pageX,o.pageY=a.pageY},mouseleave:function(b){var c=a(b.relatedTarget);if(!c.is(".context-menu-list")&&!c.closest(".context-menu-list").length){try{clearTimeout(o.timer)}catch(b){}o.timer=null}},layerClick:function(b){var c,d,e=a(this),f=e.data("contextMenuRoot"),g=b.button,h=b.pageX,j=b.pageY;b.preventDefault(),b.stopImmediatePropagation(),setTimeout(function(){var e,k="left"==f.trigger&&0===g||"right"==f.trigger&&2===g;if(document.elementFromPoint&&(f.$layer.hide(),c=document.elementFromPoint(h-i.scrollLeft(),j-i.scrollTop()),f.$layer.show()),f.reposition&&k)if(document.elementFromPoint){if(f.$trigger.is(c)||f.$trigger.has(c).length)return void f.position.call(f.$trigger,f,h,j)}else if(d=f.$trigger.offset(),e=a(window),d.top+=e.scrollTop(),d.top<=b.pageY&&(d.left+=e.scrollLeft(),d.left<=b.pageX&&(d.bottom=d.top+f.$trigger.outerHeight(),d.bottom>=b.pageY&&(d.right=d.left+f.$trigger.outerWidth(),d.right>=b.pageX))))return void f.position.call(f.$trigger,f,h,j);c&&k&&f.$trigger.one("contextmenu:hidden",function(){a(c).contextMenu({x:h,y:j})}),f.$menu.trigger("contextmenu:hide")},50)},keyStop:function(a,b){b.isInput||a.preventDefault(),a.stopPropagation()},key:function(a){var b={};switch(g&&(b=g.data("contextMenu")||{}),a.keyCode){case 9:case 38:if(q.keyStop(a,b),b.isInput){if(9==a.keyCode&&a.shiftKey)return a.preventDefault(),b.$selected&&b.$selected.find("input, textarea, select").blur(),void b.$menu.trigger("prevcommand");if(38==a.keyCode&&"checkbox"==b.$selected.find("input, textarea, select").prop("type"))return void a.preventDefault()}else if(9!=a.keyCode||a.shiftKey)return void b.$menu.trigger("prevcommand");case 40:if(q.keyStop(a,b),!b.isInput)return void b.$menu.trigger("nextcommand");if(9==a.keyCode)return a.preventDefault(),b.$selected&&b.$selected.find("input, textarea, select").blur(),void b.$menu.trigger("nextcommand");if(40==a.keyCode&&"checkbox"==b.$selected.find("input, textarea, select").prop("type"))return void a.preventDefault();break;case 37:if(q.keyStop(a,b),b.isInput||!b.$selected||!b.$selected.length)break;if(!b.$selected.parent().hasClass("context-menu-root")){var c=b.$selected.parent().parent();return b.$selected.trigger("contextmenu:blur"),void(b.$selected=c)}break;case 39:if(q.keyStop(a,b),b.isInput||!b.$selected||!b.$selected.length)break;var d=b.$selected.data("contextMenu")||{};if(d.$menu&&b.$selected.hasClass("context-menu-submenu"))return b.$selected=null,d.$selected=null,void d.$menu.trigger("nextcommand");break;case 35:case 36:return b.$selected&&b.$selected.find("input, textarea, select").length?void 0:((b.$selected&&b.$selected.parent()||b.$menu).children(":not(.disabled, .not-selectable)")[36==a.keyCode?"first":"last"]().trigger("contextmenu:focus"),void a.preventDefault());case 13:if(q.keyStop(a,b),b.isInput){if(b.$selected&&!b.$selected.is("textarea, select"))return void a.preventDefault();break}return void(b.$selected&&b.$selected.trigger("mouseup"));case 32:case 33:case 34:return void q.keyStop(a,b);case 27:return q.keyStop(a,b),void b.$menu.trigger("contextmenu:hide");default:var e=String.fromCharCode(a.keyCode).toUpperCase();if(b.accesskeys&&b.accesskeys[e])return void b.accesskeys[e].$node.trigger(b.accesskeys[e].$menu?"contextmenu:focus":"mouseup")}a.stopPropagation(),b.$selected&&b.$selected.trigger(a)},prevItem:function(b){b.stopPropagation();var c=a(this).data("contextMenu")||{};if(c.$selected){var d=c.$selected;c=c.$selected.parent().data("contextMenu")||{},c.$selected=d}for(var e=c.$menu.children(),f=c.$selected&&c.$selected.prev().length?c.$selected.prev():e.last(),g=f;f.hasClass("disabled")||f.hasClass("not-selectable");)if(f=f.prev().length?f.prev():e.last(),f.is(g))return;c.$selected&&q.itemMouseleave.call(c.$selected.get(0),b),q.itemMouseenter.call(f.get(0),b);var h=f.find("input, textarea, select");h.length&&h.focus()},nextItem:function(b){b.stopPropagation();var c=a(this).data("contextMenu")||{};if(c.$selected){var d=c.$selected;c=c.$selected.parent().data("contextMenu")||{},c.$selected=d}for(var e=c.$menu.children(),f=c.$selected&&c.$selected.next().length?c.$selected.next():e.first(),g=f;f.hasClass("disabled")||f.hasClass("not-selectable");)if(f=f.next().length?f.next():e.first(),f.is(g))return;c.$selected&&q.itemMouseleave.call(c.$selected.get(0),b),q.itemMouseenter.call(f.get(0),b);var h=f.find("input, textarea, select");h.length&&h.focus()},focusInput:function(b){var c=a(this).closest(".context-menu-item"),d=c.data(),e=d.contextMenu,f=d.contextMenuRoot;f.$selected=e.$selected=c,f.isInput=e.isInput=!0},blurInput:function(b){var c=a(this).closest(".context-menu-item"),d=c.data(),e=d.contextMenu,f=d.contextMenuRoot;f.isInput=e.isInput=!1},menuMouseenter:function(b){var c=a(this).data().contextMenuRoot;c.hovering=!0},menuMouseleave:function(b){var c=a(this).data().contextMenuRoot;c.$layer&&c.$layer.is(b.relatedTarget)&&(c.hovering=!1)},itemMouseenter:function(b){var c=a(this),d=c.data(),e=d.contextMenu,f=d.contextMenuRoot;return f.hovering=!0,b&&f.$layer&&f.$layer.is(b.relatedTarget)&&(b.preventDefault(),b.stopImmediatePropagation()),(e.$menu?e:f).$menu.children(".hover").trigger("contextmenu:blur"),c.hasClass("disabled")||c.hasClass("not-selectable")?void(e.$selected=null):void c.trigger("contextmenu:focus")},itemMouseleave:function(b){var c=a(this),d=c.data(),e=d.contextMenu,f=d.contextMenuRoot;return f!==e&&f.$layer&&f.$layer.is(b.relatedTarget)?(f.$selected&&f.$selected.trigger("contextmenu:blur"),b.preventDefault(),b.stopImmediatePropagation(),void(f.$selected=e.$selected=e.$node)):void c.trigger("contextmenu:blur")},itemClick:function(b){var c,d=a(this),e=d.data(),f=e.contextMenu,g=e.contextMenuRoot,h=e.contextMenuKey;if(f.items[h]&&!d.is(".disabled, .context-menu-submenu, .context-menu-separator, .not-selectable")){if(b.preventDefault(),b.stopImmediatePropagation(),a.isFunction(g.callbacks[h])&&Object.prototype.hasOwnProperty.call(g.callbacks,h))c=g.callbacks[h];else{if(!a.isFunction(g.callback))return;c=g.callback}c.call(g.$trigger,h,g)!==!1?g.$menu.trigger("contextmenu:hide"):g.$menu.parent().length&&r.update.call(g.$trigger,g)}},inputClick:function(a){a.stopImmediatePropagation()},hideMenu:function(b,c){var d=a(this).data("contextMenuRoot");r.hide.call(d.$trigger,d,c&&c.force)},focusItem:function(b){b.stopPropagation();var c=a(this),d=c.data(),e=d.contextMenu,f=d.contextMenuRoot;c.addClass("hover").siblings(".hover").trigger("contextmenu:blur"),e.$selected=f.$selected=c,e.$node&&f.positionSubmenu.call(e.$node,e.$menu)},blurItem:function(b){b.stopPropagation();var c=a(this),d=c.data(),e=d.contextMenu;c.removeClass("hover"),e.$selected=null}},r={show:function(b,c,d){var e=a(this),f={};return a("#context-menu-layer").trigger("mousedown"),b.$trigger=e,b.events.show.call(e,b)===!1?void(g=null):(r.update.call(e,b),b.position.call(e,b,c,d),b.zIndex&&(f.zIndex=p(e)+b.zIndex),r.layer.call(b.$menu,b,f.zIndex),b.$menu.find("ul").css("zIndex",f.zIndex+1),b.$menu.css(f)[b.animation.show](b.animation.duration,function(){e.trigger("contextmenu:visible")}),e.data("contextMenu",b).addClass("context-menu-active"),a(document).off("keydown.contextMenu").on("keydown.contextMenu",q.key),void(b.autoHide&&a(document).on("mousemove.contextMenuAutoHide",function(a){var c=e.offset();c.right=c.left+e.outerWidth(),c.bottom=c.top+e.outerHeight(),!b.$layer||b.hovering||a.pageX>=c.left&&a.pageX<=c.right&&a.pageY>=c.top&&a.pageY<=c.bottom||b.$menu.trigger("contextmenu:hide")})))},hide:function(c,d){var e=a(this);if(c||(c=e.data("contextMenu")||{}),d||!c.events||c.events.hide.call(e,c)!==!1){if(e.removeData("contextMenu").removeClass("context-menu-active"),c.$layer){setTimeout(function(a){return function(){a.remove()}}(c.$layer),10);try{delete c.$layer}catch(f){c.$layer=null}}g=null,c.$menu.find(".hover").trigger("contextmenu:blur"),c.$selected=null,a(document).off(".contextMenuAutoHide").off("keydown.contextMenu"),c.$menu&&c.$menu[c.animation.hide](c.animation.duration,function(){c.build&&(c.$menu.remove(),a.each(c,function(a,d){switch(a){case"ns":case"selector":case"build":case"trigger":return!0;default:c[a]=b;try{delete c[a]}catch(e){}return!0}})),setTimeout(function(){e.trigger("contextmenu:hidden")},10)})}},create:function(d,e){e===b&&(e=d),d.$menu=a('<ul class="context-menu-list"></ul>').addClass(d.className||"").data({contextMenu:d,contextMenuRoot:e}),a.each(["callbacks","commands","inputs"],function(a,b){d[b]={},e[b]||(e[b]={})}),e.accesskeys||(e.accesskeys={}),a.each(d.items,function(b,f){var g=a('<li class="context-menu-item"></li>').addClass(f.className||""),h=null,i=null;if(g.on("click",a.noop),f.$node=g.data({contextMenu:d,contextMenuRoot:e,contextMenuKey:b}),f.accesskey)for(var j,k=c(f.accesskey),l=0;j=k[l];l++)if(!e.accesskeys[j]){e.accesskeys[j]=f,f._name=f.name.replace(new RegExp("("+j+")","i"),'<span class="context-menu-accesskey">$1</span>');break}if("string"==typeof f)g.addClass("context-menu-separator not-selectable");else if(f.type&&m[f.type])m[f.type].call(g,f,d,e),a.each([d,e],function(c,d){d.commands[b]=f,a.isFunction(f.callback)&&(d.callbacks[b]=f.callback)});else{switch("html"==f.type?g.addClass("context-menu-html not-selectable"):f.type?(h=a("<label></label>").appendTo(g),a("<span></span>").text(f._name||f.name).appendTo(h),g.addClass("context-menu-input"),d.hasTypes=!0,a.each([d,e],function(a,c){c.commands[b]=f,c.inputs[b]=f})):f.items&&(f.type="sub"),f.type){case"text":i=a('<input type="text" value="1" name="" value="">').attr("name","context-menu-input-"+b).val(f.value||"").appendTo(h);break;case"textarea":i=a('<textarea name=""></textarea>').attr("name","context-menu-input-"+b).val(f.value||"").appendTo(h),f.height&&i.height(f.height);break;case"checkbox":i=a('<input type="checkbox" value="1" name="" value="">').attr("name","context-menu-input-"+b).val(f.value||"").prop("checked",!!f.selected).prependTo(h);break;case"radio":i=a('<input type="radio" value="1" name="" value="">').attr("name","context-menu-input-"+f.radio).val(f.value||"").prop("checked",!!f.selected).prependTo(h);break;case"select":i=a('<select name="">').attr("name","context-menu-input-"+b).appendTo(h),f.options&&(a.each(f.options,function(b,c){a("<option></option>").val(b).text(c).appendTo(i)}),i.val(f.selected));break;case"sub":a("<span></span>").text(f._name||f.name).appendTo(g),f.appendTo=f.$node,r.create(f,e),g.data("contextMenu",f).addClass("context-menu-submenu"),f.callback=null;break;case"html":a(f.html).appendTo(g);break;default:a.each([d,e],function(c,d){d.commands[b]=f,a.isFunction(f.callback)&&(d.callbacks[b]=f.callback)}),a("<span></span>").text(f._name||f.name||"").appendTo(g)}f.type&&"sub"!=f.type&&"html"!=f.type&&(i.on("focus",q.focusInput).on("blur",q.blurInput),f.events&&i.on(f.events,d)),f.icon&&g.addClass("icon icon-"+f.icon)}f.$input=i,f.$label=h,g.appendTo(d.$menu),!d.hasTypes&&a.support.eventSelectstart&&g.on("selectstart.disableTextSelect",q.abortevent)}),d.$node||d.$menu.css("display","none").addClass("context-menu-root"),d.$menu.appendTo(d.appendTo||document.body)},resize:function(b,c){b.css({position:"absolute",display:"block"}),b.data("width",Math.ceil(b.width())+1),b.css({position:"static",minWidth:"0px",maxWidth:"100000px"}),b.find("> li > ul").each(function(){r.resize(a(this),!0)}),c||b.find("ul").addBack().css({position:"",display:"",minWidth:"",maxWidth:""}).width(function(){return a(this).data("width")})},update:function(c,d){var e=this;d===b&&(d=c,r.resize(c.$menu)),c.$menu.children().each(function(){var b=a(this),f=b.data("contextMenuKey"),g=c.items[f],h=a.isFunction(g.disabled)&&g.disabled.call(e,f,d)||g.disabled===!0;if(b[h?"addClass":"removeClass"]("disabled"),g.type)switch(b.find("input, select, textarea").prop("disabled",h),g.type){case"text":case"textarea":g.$input.val(g.value||"");break;case"checkbox":case"radio":g.$input.val(g.value||"").prop("checked",!!g.selected);break;case"select":g.$input.val(g.selected||"")}g.$menu&&r.update.call(e,g,d)})},layer:function(c,d){var e=c.$layer=a('<div id="context-menu-layer" style="position:fixed; z-index:'+d+'; top:0; left:0; opacity: 0; filter: alpha(opacity=0); background-color: #000;"></div>').css({height:i.height(),width:i.width(),display:"block"}).data("contextMenuRoot",c).insertBefore(this).on("contextmenu",q.abortevent).on("mousedown",q.layerClick);return document.body.style.maxWidth===b&&e.css({position:"absolute",height:a(document).height()}),e}};a.fn.contextMenu=function(c){if(c===b)this.first().trigger("contextmenu");else if(c.x&&c.y)this.first().trigger(a.Event("contextmenu",{pageX:c.x,pageY:c.y}));else if("hide"===c){var d=this.first().data("contextMenu")?this.first().data("contextMenu").$menu:null;d&&d.trigger("contextmenu:hide")}else"destroy"===c?a.contextMenu("destroy",{context:this}):a.isPlainObject(c)?(c.context=this,a.contextMenu("create",c)):c?this.removeClass("context-menu-disabled"):c||this.addClass("context-menu-disabled");return this},a.contextMenu=function(c,d){"string"!=typeof c&&(d=c,c="create"),"string"==typeof d?d={selector:d}:d===b&&(d={});var e=a.extend(!0,{},n,d||{}),f=a(document),g=f,i=!1;switch(e.context&&e.context.length?(g=a(e.context).first(),e.context=g.get(0),i=e.context!==document):e.context=document,c){case"create":if(!e.selector)throw new Error("No selector specified");if(e.selector.match(/.context-menu-(list|item|input)($|\s)/))throw new Error('Cannot bind to selector "'+e.selector+'" as it contains a reserved className');if(!e.build&&(!e.items||a.isEmptyObject(e.items)))throw new Error("No Items specified");switch(j++,e.ns=".contextMenu"+j,i||(k[e.selector]=e.ns),l[e.ns]=e,e.trigger||(e.trigger="right"),h||(f.on({"contextmenu:hide.contextMenu":q.hideMenu,"prevcommand.contextMenu":q.prevItem,"nextcommand.contextMenu":q.nextItem,"contextmenu.contextMenu":q.abortevent,"mouseenter.contextMenu":q.menuMouseenter,"mouseleave.contextMenu":q.menuMouseleave},".context-menu-list").on("mouseup.contextMenu",".context-menu-input",q.inputClick).on({"mouseup.contextMenu":q.itemClick,"contextmenu:focus.contextMenu":q.focusItem,"contextmenu:blur.contextMenu":q.blurItem,"contextmenu.contextMenu":q.abortevent,"mouseenter.contextMenu":q.itemMouseenter,"mouseleave.contextMenu":q.itemMouseleave},".context-menu-item"),h=!0),g.on("contextmenu"+e.ns,e.selector,e,q.contextmenu),i&&g.on("remove"+e.ns,function(){a(this).contextMenu("destroy")}),e.trigger){case"hover":g.on("mouseenter"+e.ns,e.selector,e,q.mouseenter).on("mouseleave"+e.ns,e.selector,e,q.mouseleave);break;case"left":g.on("click"+e.ns,e.selector,e,q.click)}e.build||r.create(e);break;case"destroy":var m;if(i){var o=e.context;a.each(l,function(b,c){if(c.context!==o)return!0;m=a(".context-menu-list").filter(":visible"),m.length&&m.data().contextMenuRoot.$trigger.is(a(c.context).find(c.selector))&&m.trigger("contextmenu:hide",{force:!0});try{l[c.ns].$menu&&l[c.ns].$menu.remove(),delete l[c.ns]}catch(d){l[c.ns]=null}return a(c.context).off(c.ns),!0})}else if(e.selector){if(k[e.selector]){m=a(".context-menu-list").filter(":visible"),m.length&&m.data().contextMenuRoot.$trigger.is(e.selector)&&m.trigger("contextmenu:hide",{force:!0});try{l[k[e.selector]].$menu&&l[k[e.selector]].$menu.remove(),delete l[k[e.selector]]}catch(p){l[k[e.selector]]=null}f.off(k[e.selector])}}else f.off(".contextMenu .contextMenuAutoHide"),a.each(l,function(b,c){a(c.context).off(c.ns)}),k={},l={},j=0,h=!1,a("#context-menu-layer, .context-menu-list").remove();break;case"html5":(!a.support.htmlCommand&&!a.support.htmlMenuitem||"boolean"==typeof d&&d)&&a('menu[type="context"]').each(function(){this.id&&a.contextMenu({selector:"[contextmenu="+this.id+"]",items:a.contextMenu.fromMenu(this)})}).css("display","none");break;default:throw new Error('Unknown operation "'+c+'"')}return this},a.contextMenu.setInputValues=function(c,d){d===b&&(d={}),a.each(c.inputs,function(a,b){switch(b.type){case"text":case"textarea":b.value=d[a]||"";break;case"checkbox":b.selected=d[a]?!0:!1;break;case"radio":b.selected=(d[b.radio]||"")==b.value?!0:!1;break;case"select":b.selected=d[a]||""}})},a.contextMenu.getInputValues=function(c,d){return d===b&&(d={}),a.each(c.inputs,function(a,b){switch(b.type){case"text":case"textarea":case"select":d[a]=b.$input.val();break;case"checkbox":d[a]=b.$input.prop("checked");break;case"radio":b.$input.prop("checked")&&(d[b.radio]=b.value)}}),d},a.contextMenu.fromMenu=function(b){var c=a(b),d={};return e(d,c.children()),d},a.contextMenu.defaults=n,a.contextMenu.types=m,a.contextMenu.handle=q,a.contextMenu.op=r,a.contextMenu.menus=l}(jQuery);var ListenerAssigner=function(){function a(){$("#search-button").off().on("click",ItemFinder.find)}function b(){$("#search-field").off().on("keyup",function(a){13==a.keyCode&&$("#search-button").click()})}function c(){$("#filters").find("> .filter").find(" .title").off().on("click",function(){var a=this.__data__.name;ChartManager.changeAxisByName(a),FilterUI.refresh()})}function d(){$("#filters").find("div.filter option").off("dblclick").on("dblclick",ItemFinder.find)}function e(){$("#filters").find("div.filter select").off("change").on("change",Main.applyFilters)}function f(){$("#filters").find("> .filter").find(" .arrow").off().on("click",function(){var a=this.parentNode,b=a.parentNode;FilterUI.toggleExpanded(b)})}function g(){var a=$("#request-log");a.dialog("isOpen")?a.dialog("close"):a.dialog("open")}function h(){$("#request-log").dialog("option","position",{my:"left top",at:"left bottom",of:$("#message")})}var i={};return i.bindSearchFieldEvents=function(){a(),b()},i.bindFilterListeners=function(){f(),c(),d(),e()},i.bindRequestLogDialog=function(){$("#message").off().on("click",function(){h(),g()})},i}(),Main=function(){function a(a,c){var d=b(a);c.forEach(function(a){for(var b in d)d.hasOwnProperty(b)&&(a.aspects[b]={value:d[b],confidence:2})})}function b(a){var b=a.aspects.filter(function(a){return 1==a.selected.length}),c={};return b.forEach(function(a){var b=a.filter.name;c[b]=a.selected[0]}),c}var c={};return c.init=function(){ListenerAssigner.bindSearchFieldEvents(),Filters.populate()},c.applyFilters=function(){var a=Items.filter();MessageUI.setFiltered(a.length),ChartManager.setData(a)},c.updateChart=function(b,c){AspectGuesser.guessAspectsFromTitle(c),a(b,c),Items.add(c);var d=Items.filter();d.length&&(MessageUI.setFiltered(d.length),ChartManager.onNewItems(d))},c}(),MessageUI=function(){function a(){var a=c()||b();$("#message").text(a)}function b(){return"Showing "+g+"/"+f+" items:"}function c(){var a=RequestLog.getHistory(),b="";if(a){var c=a.filter(d);c.length&&(b=Items.count()?"Finding more...":"Finding...")}return b}function d(a){return a.isPending}var e={},f=0,g=0;return e.setTotal=function(b){f=b,a()},e.setFiltered=function(b){g=b,a()},e.updateRequestStatus=function(){a()},e}(),RequestLog=function(){function a(a,b){a.lastItem=a.lastItem||0,a.lastItem+=b.itemsReturned,a.totalItems=b.totalItems}function b(a){var b,f=e(a),g=l.get(f);return b=g?d(g):c(f)}function c(a){return a.itemsPerPage=m,a.page=1,a}function d(a){var b=a.page||0;return a.page=b+1,a.itemsPerPage=m,a}function e(a){return a.filters=f(a.filters),a.aspects=f(a.aspects),a}function f(a){a.forEach(g);var b=a.map(i).sort(naturalSort),c=mapAsObject(a,i);return b.map(function(a){return c[a]})}function g(a){a.selected=a.selected.sort(naturalSort)}function h(a){var b={};return b.keywords=a.keywords,b.filters=a.filters,b.aspects=a.aspects,JSON.stringify(b)}function i(a){return a.filter.name}function j(){MessageUI.updateRequestStatus(),RequestLogUI.update()}var k={};k.logDivId="#request-log",k.getHashKey=h;var l,m=20;return k.init=function(){l=new Set(h)},k.getHistory=function(){return l.toArray()},k.notifyNewRequestAndGetPaging=function(a){var c=b(a);return c.isPending=!0,l.add(c),j(),c},k.notifyRequestSuccessful=function(b,c){delete b.isPending,delete b.failed,a(b,c),j()},k.notifyRequestFailed=function(a){delete a.isPending,a.failed=!0,j()},k}(),RequestLogUI=function(){function a(a){var c=d3.select(k).select("table").select("tbody").selectAll("tr").data(a,RequestLog.getHashKey);c.call(b),c.enter().append("tr").call(b),c.exit().remove()}function b(a){a.empty()||(a.classed("flashing-bg",f).classed("failed",g),a.html(""),a.append("td").classed("description",!0).html(c),a.append("td").classed("count",!0).html(h))}function c(a){var b=d(a.filters),c=d(a.aspects),e=[a.keywords,b,c].filter(notEmpty);return e.join(", ")}function d(a){if(!a)return"";var b=a.map(e);return b.join(", ")}function e(a){var b=a.filter.getValueLabel,c=a.selected.map(b);return c.join(", ")}function f(a){return 1==a.isPending}function g(a){return 1==a.failed}function h(a){var b="";return a.lastItem&&(b+=a.lastItem),a.totalItems&&(b+="/"+i(a.totalItems)),b}function i(a){return a>m?Math.floor(a/m)+"bi":a>l?Math.floor(a/l)+"mi":a>1e3?Math.floor(a/1e3)+"k":a}var j={},k=RequestLog.logDivId;j.init=function(){j.update(),$(k).dialog({autoOpen:!1}),ListenerAssigner.bindRequestLogDialog()},j.update=function(){var b=RequestLog.getHistory();a(b)};var l=Math.pow(1e3,2),m=Math.pow(1e3,3);return j}(),UIParamsInput=function(){function a(a){var c=[];return $(a).find("select").each(function(a,d){var e=$(d).find("option").filter(":selected");if(e.length>0){var f=b(d.__data__,e);c.push(f)}}),c}function b(a,b){return{filter:a,selected:b.toArray().map(function(a){return a.__data__})}}var c={};return c.getParams=function(){return{keywords:$("#search-field").val(),filters:a(".common-filter"),aspects:a(".aspect-filter")}},c}();Set.prototype={add:function(a){var b=this._hashFunction(a);this.contains(a)||(this._values[b]=a,this._size++)},addAll:function(a){for(var b,c=0;b=a[c];c++)this.add(b)},addMerge:function(a,b){var c=this._hashFunction(a);if(this.contains(a)){var d=this._values[c];b(d,a)}else this._values[c]=a,this._size++},addMergeAll:function(a,b){for(var c,d=0;c=a[d];d++)this.addMerge(c,b)},addMap:function(a,b){for(var c,d=0;c=a[d];d++)this.add(b(c))},remove:function(a){this.contains(a)&&(delete this.get(a),this._size--)},get:function(a){return this._values[this._hashFunction(a)]},contains:function(a){return"undefined"!=typeof this.get(a)},size:function(){return this._size},empty:function(){return 0==this._size},each:function(a,b){for(var c in this._values)a.call(b,this._values[c])},toArray:function(){var a=[],b=0;for(var c in this._values)a[b]=this._values[c],b++;return a},filter:function(a){var b=[];for(var c in this._values){var d=this._values[c];a(d)&&b.push(d)}return b}};